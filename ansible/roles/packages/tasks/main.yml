- name: Check if Homebrew is installed
  command: brew --version
  register: brew_check
  ignore_errors: true
- block:
    - name: Ensure we can sudo
      become: yes
      command: echo &> /dev/null
    - name: Install Homebrew
      become: no
      shell: |
        /usr/bin/env CI=1 NONINTERACTIVE=1 /bin/bash -c \
        "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        eval $(/opt/homebrew/bin/brew shellenv)
      args:
        executable: /bin/bash
    - name: Add Homebrew shellenv to fish configuration
      lineinfile:
        path: ~/.config/fish/config.fish
        line: '/opt/homebrew/bin/brew shellenv | source'
        state: present
      when: ansible_env.SHELL == "/opt/homebrew/bin/fish"
    - name: Add Homebrew shellenv to zsh configuration
      lineinfile:
        path: ~/.zshrc
        line: 'eval "$(/opt/homebrew/bin/brew shellenv)"'
        state: present
      when: ansible_env.SHELL == "/bin/zsh"
    - name: Add Homebrew shellenv to bash configuration
      lineinfile:
        path: ~/.bashrc
        line: 'eval "$(/opt/homebrew/bin/brew shellenv)"'
        state: present
      when: ansible_env.SHELL == "/bin/bash"
    - name: Apply Homebrew shellenv immediately
      shell: eval "$(/usr/local/bin/brew shellenv)"
      args:
        executable: /bin/bash
  when: brew_check.rc != 0
- name: Install homebrew formulae
  community.general.homebrew:
    name:
      - awscli
      - bat
      - btop
      - curl
      - direnv # environment loading on entering a directory
      - doggo # DNS like dig
      - eza # nice ls
      - fd # faster find
      - ffmpeg
      - fish
      - fzf # fuzzy finder
      - git
      - git-delta # fancy diffs
      - htop
      - httpie # HTTP client
      - hyperfine # benchmarking
      - inetutils # telnet, whois, etc
      - jless # JSON view
      - jo # JSON output
      - jq # JSON manipulator
      - keychain
      - lazydocker
      - lazygit
      - less
      - lz4 # compression
      - neovim
      - openssh
      - p7zip
      - prettyping
      - ripgrep
      - starship
      - stow
      - tealdeer
      - tree
      - unzip
      - uv
      - yt-dlp
      - zoxide
    state: present
- name: Install homebrew casks
  community.general.homebrew_cask:
    name:
      - 1password
      - brave-browser
      - firefox
      - jetbrains-toolbox
      - karabiner-elements
      - linearmouse
      - monitorcontrol
      - mullvadvpn
      - notion
      - notion-calendar
      - postgres-unofficial
      - raycast
      - signal
      - slack
      - stats
      - tailscale
      - utm
      - wezterm
    state: present
