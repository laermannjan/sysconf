#!/usr/bin/env bash

set -e

SYSCONF_DIR="${HOME}/sysconf"
HOMEBREW_PREFIX=$(if [[ $(uname) = 'Darwin' ]]; then echo "/opt/homebrew"; else echo "/home/linuxbrew/.linuxbrew"; fi)


if [[ -t 1 ]]
then
  tty_escape() { printf "\033[%sm" "$1"; }
else
  tty_escape() { :; }
fi
tty_mkbold() { tty_escape "1;$1"; }
tty_underline="$(tty_escape "4;39")"
tty_blue="$(tty_mkbold 34)"
tty_red="$(tty_mkbold 31)"
tty_bold="$(tty_mkbold 39)"
tty_reset="$(tty_escape 0)"

ohai() {
  printf "${tty_blue}==>${tty_bold} %s${tty_reset}\n" "$1"
}

have() {
    command -v "$1" &>/dev/null
}

ohai "installing brew requirements"
have apt && sudo apt update && sudo apt -y install build-essential procps curl file git
have dnf && sudo dnf group install -y 'Development Tools' && sudo dnf install -y procps-ng curl file git
have pacman && sudo pacman -Syu --no-confirm base-devel procps-ng curl file git

ohai "ensuring brew is installed, available and up to date"
have brew || NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
have brew || export PATH="${HOMEBREW_PREFIX}/bin:${PATH}"
have brew && brew update || { echo "brew still not found after installing and prepending PATH" 1>&2; exit 1; }

ohai "ensuring ansible is installed"
have ansible || brew install ansible

ohai "ensuring ansible collections are installed"
ansible-galaxy collection list | grep community.general || ansible-galaxy collection install community.general
ansible-galaxy collection list | grep geerlingguy.mac || ansible-galaxy collection install geerlingguy.mac

if [[ ! -d "${SYSCONF_DIR}" ]]; then
  ohai "cloning sysconf repo to ${SYSCONF_DIR}"
  git clone https://github.com/laermannjan/sysconf.git "${SYSCONF_DIR}"
  git -C "${SYSCONF_DIR}" remote set-url origin git@github.com:laermannjan/sysconf.git
fi


ohai "running ansible playbook"
ansible-playbook ~/sysconf/ansible/playbook.yml --ask-vault-pass

ohai "Done. Invoking fish shell. You should reboot now."
exec fish
